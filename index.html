<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wizz Air „Éï„É©„Ç§„ÉàÊ§úÁ¥¢ - „É¢„Éê„Ç§„É´Áâà</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #C2185B;
            --primary-dark: #8E0038;
            --accent: #FF6090;
            --bg-main: #F5F5F5;
            --bg-card: #FFFFFF;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border: #E0E0E0;
            --shadow: rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #C2185B 0%, #FF6090 100%);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Header - „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
        header {
            background: var(--gradient);
            padding: 1.5rem 1rem;
            box-shadow: 0 2px 10px rgba(194, 24, 91, 0.2);
            position: static;
        }

        .header-title {
            background: none;
            border: none;
            padding: 0;
            text-align: left;
            cursor: pointer;
        }

        h1 {
            font-family: 'Montserrat', 'Noto Sans JP', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            color: white;
            margin-bottom: 0.3rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.95);
            font-size: 0.85rem;
            font-weight: 400;
        }

        /* Search Container - „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
        .search-container {
            padding: 1rem;
            background: white;
            box-shadow: 0 2px 8px var(--shadow);
            position: static;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            z-index: 2;
        }

        #searchInput {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: 1rem;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.3s ease;
            background: var(--bg-main);
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(194, 24, 91, 0.1);
            background: white;
        }

        /* Autocomplete - „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
        .autocomplete-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 16px;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 1.2rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border);
            min-height: 60px;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:active {
            background: linear-gradient(135deg, rgba(194, 24, 91, 0.1) 0%, rgba(255, 96, 144, 0.1) 100%);
        }

        .autocomplete-item-main {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
            font-size: 1.05rem;
        }

        .autocomplete-item-code {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .autocomplete-item-sub {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Filter Buttons - „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.5rem;
            scrollbar-width: none;
        }

        .filter-buttons::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid var(--border);
            background: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 44px;
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        .filter-btn.active {
            background: var(--gradient);
            color: white;
            border-color: var(--primary);
        }

        /* Results Container */
        .results-container {
            padding: 1rem;
        }

        .quick-panel {
            padding: 0 1rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .ghost-btn {
            border: 1px solid var(--border);
            background: white;
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            min-height: 36px;
        }

        .section-card {
            background: white;
            border-radius: 16px;
            border: 2px solid var(--border);
            padding: 0.9rem 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
        }

        .chip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.6rem;
        }

        .rank-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
            padding: 0.55rem 0.7rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
        }

        .rank-left {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .rank-badge {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            background: var(--gradient);
            color: white;
            font-weight: 800;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .rank-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .results-count {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .results-count strong {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .sort-select {
            padding: 0.7rem 1rem;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            background: white;
            font-weight: 600;
            min-height: 44px;
        }

        /* Flight Cards - „É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
        .flights-grid {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .flight-group {
            background: var(--bg-card);
            border-radius: 14px;
            border: 2px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            cursor: pointer;
        }

        .flight-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.9rem 1rem;
            background: linear-gradient(135deg, rgba(194, 24, 91, 0.08) 0%, rgba(255, 96, 144, 0.08) 100%);
        }

        .airport-title {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .airport-code {
            font-size: 1.15rem;
            font-weight: 900;
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
        }

        .airport-name {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .airport-country {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .airport-actions {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .star-btn {
            border: 1px solid var(--border);
            background: white;
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.35rem 0.6rem;
            font-size: 0.9rem;
            cursor: pointer;
            min-height: 36px;
        }

        .star-btn.active {
            color: #FFC107;
            border-color: #FFC107;
        }

        .code-copy-btn {
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 999px;
            padding: 0.35rem 0.7rem;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            min-height: 36px;
        }

        .flight-group-body {
            padding: 0.85rem 1rem 1rem;
        }

        .destinations {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.6rem;
        }

        .airport-chip {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            padding: 0.6rem 0.7rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .airport-chip:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .airport-chip-code {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
        }

        .airport-chip-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .airport-chip-country {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .airport-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
            font-weight: 600;
        }

        .detail-airport-name {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 33, 33, 0.95);
            color: white;
            padding: 0.7rem 1rem;
            border-radius: 999px;
            font-size: 0.9rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-6px);
        }

        .no-results {
            text-align: center;
            padding: 3rem 1.5rem;
            background: white;
            border-radius: 16px;
            border: 2px dashed var(--border);
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .no-results h3 {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .no-results p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Footer */
        footer {
            background: var(--text-primary);
            color: white;
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 2rem;
        }

        footer p {
            opacity: 0.8;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flight-group {
            animation: fadeInUp 0.4s ease;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(194, 24, 91, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÈùûË°®Á§∫ÔºàiOSÂØæÂøúÔºâ */
        .autocomplete-dropdown {
            -webkit-overflow-scrolling: touch;
        }

        /* „Çø„ÉÉ„ÉÅ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÊîπÂñÑ */
        .flight-group, .filter-btn, .autocomplete-item, .airport-chip, .code-copy-btn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .is-hidden {
            display: none;
        }

        .detail-view {
            padding: 1rem;
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .detail-sort {
            border: 2px solid var(--border);
            background: white;
            border-radius: 999px;
            padding: 0.45rem 0.8rem;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            min-height: 40px;
        }

        .country-group {
            margin-top: 0.8rem;
            padding: 0.7rem 0.9rem 0.9rem;
            border-radius: 14px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
            border-left: 6px solid var(--group-color, var(--primary));
        }

        .country-title {
            font-size: 0.85rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.4rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        .back-btn {
            border: 2px solid var(--border);
            background: white;
            border-radius: 999px;
            padding: 0.5rem 0.9rem;
            font-weight: 700;
            cursor: pointer;
            min-height: 40px;
        }

        .detail-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .detail-sub {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .detail-country-link {
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
        }

        .detail-card {
            background: white;
            border-radius: 16px;
            border: 2px solid var(--border);
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.7rem;
            margin-top: 0.8rem;
        }

        .detail-chip-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        @media (max-width: 600px) {
            header {
                padding: 1.2rem 1rem;
            }

            h1 {
                font-size: 1.3rem;
            }

            .search-container {
                padding: 0.9rem 0.9rem 1rem;
            }

            #searchInput {
                padding: 0.85rem 0.85rem 0.85rem 2.7rem;
                font-size: 0.95rem;
            }

            .filter-btn {
                padding: 0.7rem 1.1rem;
                font-size: 0.9rem;
            }

            .results-container {
                padding: 0.9rem;
            }

            .flight-group-header {
                padding: 0.75rem 0.9rem;
            }

            .flight-group-body {
                padding: 0.75rem 0.9rem 0.9rem;
            }

            .destinations {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .detail-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <button class="header-title" id="homeButton" type="button">
            <h1>‚úàÔ∏è Wizz Air Ê§úÁ¥¢</h1>
        </button>
        <p class="subtitle">„É®„Éº„É≠„ÉÉ„Éë„Éª‰∏≠Êù± ÂÖ®2,000Ë∑ØÁ∑ö</p>
    </header>

    <div id="listView">
        <div class="search-container">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="ÈÉΩÂ∏ÇÂêç„ÅßÊ§úÁ¥¢Ôºà„Å≤„Çâ„Åå„Å™„ÉªËã±Ë™ûOKÔºâ"
                    autocomplete="off"
                >
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">„Åô„Åπ„Å¶</button>
                <button class="filter-btn" data-filter="favorites" id="favoritesTabBtn">„ÅäÊ∞ó„Å´ÂÖ•„Çä</button>
                <button class="filter-btn" data-filter="ranking">Êé•Á∂öÊï∞„ÅÆÂ§ö„ÅÑÁ©∫Ê∏Ø</button>
                <button class="filter-btn" data-filter="Ë•øÊ¨ß">Ë•øÊ¨ß</button>
                <button class="filter-btn" data-filter="Êù±Ê¨ß">Êù±Ê¨ß</button>
                <button class="filter-btn" data-filter="ÂçóÊ¨ß">ÂçóÊ¨ß</button>
                <button class="filter-btn" data-filter="ÂåóÊ¨ß">ÂåóÊ¨ß</button>
                <button class="filter-btn" data-filter="‰∏≠Êù±">‰∏≠Êù±</button>
            </div>
        </div>

        <div class="quick-panel">
            <div class="section-card is-hidden" id="favoritesSection">
                <div class="section-title">„ÅäÊ∞ó„Å´ÂÖ•„Çä</div>
                <div class="chip-grid" id="favoritesGrid"></div>
            </div>
            <div class="section-card" id="rankingSection">
                <div class="section-title">
                    Êé•Á∂öÊï∞„ÅÆÂ§ö„ÅÑÁ©∫Ê∏Ø
                    <button class="ghost-btn" id="rankingToggleBtn" type="button">„ÇÇ„Å£„Å®Ë¶ã„Çã</button>
                </div>
                <div class="chip-grid" id="rankingGrid"></div>
            </div>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="results-header">
                <div class="results-count">
                    Âá∫Áô∫Á©∫Ê∏Ø <strong id="groupCount">0</strong> / Ë∑ØÁ∑ö <strong id="resultCount">0</strong>
                </div>
                <select class="sort-select" id="sortSelect">
                    <option value="default">„Éá„Éï„Ç©„É´„ÉàÈ†Ü</option>
                    <option value="ja-asc">Âá∫Áô∫Âú∞È†ÜÔºà„ÅÇ‚Üí„ÇìÔºâ</option>
                    <option value="ja-desc">Âá∫Áô∫Âú∞È†ÜÔºà„Çì‚Üí„ÅÇÔºâ</option>
                </select>
            </div>
            <div class="flights-grid" id="flightsGrid"></div>
        </div>
    </div>

    <div id="detailView" class="detail-view is-hidden">
        <div class="detail-header">
            <button class="back-btn" id="backButton">‚Üê Êàª„Çã</button>
            <div>
                <div class="detail-title" id="detailTitle">Á©∫Ê∏ØË©≥Á¥∞</div>
                <div class="detail-sub" id="detailSub">Êé•Á∂ö„Åó„Å¶„ÅÑ„ÇãÁ©∫Ê∏Ø‰∏ÄË¶ß</div>
            </div>
            <select class="detail-sort" id="detailSort">
                <option value="count">Êé•Á∂öÊï∞„ÅåÂ§ö„ÅÑÈ†Ü</option>
                <option value="country">ÂõΩ„Åß„Åæ„Å®„ÇÅ„Å¶Ë°®Á§∫</option>
            </select>
            <div class="airport-actions">
                <button class="star-btn" id="detailFavBtn" type="button">‚òÖ</button>
                <button class="code-copy-btn" id="detailCopyBtn" type="button">„Ç≥„Éº„Éâ„Ç≥„Éî„Éº</button>
                <button class="ghost-btn" id="detailNameCopyBtn" type="button">Á©∫Ê∏ØÂêç„Ç≥„Éî„Éº</button>
                <a class="ghost-btn" id="detailMapBtn" href="#" target="_blank" rel="noopener">Âú∞Âõ≥„ÇíË¶ã„Çã</a>
            </div>
        </div>
        <div class="detail-card">
            <div class="detail-sub" id="detailCount">Êé•Á∂öÊï∞: 0</div>
            <div class="detail-grid" id="detailGrid"></div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Wizz Air „Éï„É©„Ç§„ÉàÊ§úÁ¥¢<br>ÈùûÂÖ¨Âºè„É¢„Éê„Ç§„É´Áâà</p>
        <p style="margin-top: 0.5rem;">ÂÆüÈöõ„ÅÆ‰∫àÁ¥Ñ„ÅØ <a href="https://www.wizzair.com">wizzair.com</a> „Å∏</p>
    </footer>

    <div class="toast" id="toast">„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü</div>

    <script src="./data.js"></script>
    <script>
        const {
            airportCodes = {},
            cityNames = {},
            countryMap = {},
            regionMap = {},
            rawFlightData = '',
            airportGoogleMap = {},
            airportFullNames = {}
        } = window.AIRPORT_DATA || {};
        const dataLoaded = Boolean(window.AIRPORT_DATA) && Boolean(rawFlightData);
        // Á©∫Ê∏Ø„Ç≥„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞


        // „Éá„Éº„Çø„Éë„Éº„Çπ
        const flightsData = rawFlightData
            ? rawFlightData.trim().split('\n').map(line => {
                const [from, to] = line.split(' - ');
                return {
                    from: from.trim(),
                    to: to.trim(),
                    fromCode: airportCodes[from.trim()] || '???',
                    toCode: airportCodes[to.trim()] || '???',
                    fromCity: cityNames[from.trim()] || from.trim(),
                    toCity: cityNames[to.trim()] || to.trim(),
                    fromCountry: countryMap[from.trim()] || '',
                    toCountry: countryMap[to.trim()] || '',
                    region: regionMap[from.trim()] || 'Ë•øÊ¨ß'
                };
            })
            : [];

let filteredFlights = [...flightsData];
let currentFilter = 'all';
let currentSort = 'default';
let uniqueCities = [];
let searchMode = 'routes';
let currentDetailAirport = '';
let detailSortMode = 'count';
let rankingExpanded = false;
let hasFavorites = false;

        // „É¶„Éã„Éº„ÇØ„Å™ÈÉΩÂ∏Ç„É™„Çπ„Éà‰ΩúÊàê
        const citySet = new Set();
        flightsData.forEach(flight => {
            citySet.add(JSON.stringify({
                en: flight.from,
                code: flight.fromCode,
                ja: flight.fromCity,
                country: flight.fromCountry
            }));
            citySet.add(JSON.stringify({
                en: flight.to,
                code: flight.toCode,
                ja: flight.toCity,
                country: flight.toCountry
            }));
        });
        uniqueCities = Array.from(citySet).map(city => JSON.parse(city));
        const cityInfoByEn = new Map(uniqueCities.map(city => [city.en, city]));

        // Êé•Á∂öÁ©∫Ê∏Ø„Éû„ÉÉ„ÉóÔºàÂèåÊñπÂêëÔºâ
        const connectionsMap = new Map();
        flightsData.forEach(flight => {
            if (!connectionsMap.has(flight.from)) {
                connectionsMap.set(flight.from, new Set());
            }
            if (!connectionsMap.has(flight.to)) {
                connectionsMap.set(flight.to, new Set());
            }
            connectionsMap.get(flight.from).add(flight.to);
            connectionsMap.get(flight.to).add(flight.from);
        });

        let storageAvailable = true;
        try {
            const testKey = '__wizz_storage_test__';
            localStorage.setItem(testKey, '1');
            localStorage.removeItem(testKey);
        } catch (err) {
            storageAvailable = false;
        }

        function safeGet(key, fallback) {
            if (!storageAvailable) return fallback;
            const value = localStorage.getItem(key);
            return value === null ? fallback : value;
        }

        function safeSet(key, value) {
            if (!storageAvailable) return;
            localStorage.setItem(key, value);
        }

        const favorites = new Set(JSON.parse(safeGet('favorites', '[]') || '[]'));

        function saveFavorites() {
            safeSet('favorites', JSON.stringify(Array.from(favorites)));
        }

        function isFavorite(airportEn) {
            return favorites.has(airportEn);
        }

        function toggleFavorite(airportEn) {
            if (favorites.has(airportEn)) {
                favorites.delete(airportEn);
            } else {
                favorites.add(airportEn);
            }
            saveFavorites();
            renderFavoritesSection();
            renderRankingSection();
            displayFlights(filteredFlights);
        }

        function renderFavoritesSection() {
            const list = Array.from(favorites).map(name => cityInfoByEn.get(name))
                .filter(Boolean)
                .sort((a, b) => a.ja.localeCompare(b.ja, 'ja'));
            hasFavorites = list.length > 0;

            if (list.length === 0) {
                if (favoritesTabBtn) {
                    favoritesTabBtn.classList.add('is-hidden');
                }
                favoritesSection.classList.add('is-hidden');
                if (currentFilter === 'favorites') {
                    currentFilter = 'all';
                    filterButtons.forEach(b => b.classList.remove('active'));
                    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
                    if (allButton) {
                        allButton.classList.add('active');
                    }
                }
                favoritesGrid.innerHTML = `
                    <div class="rank-meta">„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                `;
                return;
            }

            if (favoritesTabBtn) {
                favoritesTabBtn.classList.remove('is-hidden');
            }
            favoritesSection.classList.remove('is-hidden');
            favoritesGrid.innerHTML = list.map(city => `
                <div class="airport-chip" data-airport="${city.en}">
                    <div class="airport-chip-code">${city.code}</div>
                    <div class="airport-chip-name">${city.ja}</div>
                    <div class="airport-chip-country">${city.country}</div>
                </div>
            `).join('');
        }

        function renderRankingSection() {
            const ranking = Array.from(connectionsMap.keys()).map(name => {
                const info = cityInfoByEn.get(name) || { en: name, ja: name, code: '???', country: '' };
                return {
                    en: info.en,
                    ja: info.ja,
                    code: info.code,
                    country: info.country,
                    count: connectionsMap.get(name).size
                };
            }).sort((a, b) => b.count - a.count);

            const isHome = currentFilter === 'all';
            const limit = isHome && !rankingExpanded ? 14 : ranking.length;
            const view = ranking.slice(0, limit);
            if (rankingToggleBtn) {
                rankingToggleBtn.textContent = isHome && !rankingExpanded ? '„ÇÇ„Å£„Å®Ë¶ã„Çã' : 'Èñâ„Åò„Çã';
                rankingToggleBtn.classList.toggle('is-hidden', !isHome);
            }

            rankingGrid.innerHTML = view.map((item, index) => `
                <div class="rank-item" data-airport="${item.en}">
                    <div class="rank-left">
                        <div class="rank-badge">${index + 1}</div>
                        <div>
                            <div class="airport-chip-name">${item.ja}Ôºà${item.code}Ôºâ</div>
                            <div class="rank-meta">${item.country}</div>
                        </div>
                    </div>
                    <div class="rank-meta">${item.count} Êé•Á∂ö</div>
                </div>
            `).join('');
        }

        function updateTabView() {
            const isFavorites = currentFilter === 'favorites';
            const isRanking = currentFilter === 'ranking';
            const isHome = currentFilter === 'all';
            const isSearching = Boolean(searchInput && searchInput.value.trim());

            favoritesSection.classList.toggle('is-hidden', !(isHome || isFavorites) || isSearching || !hasFavorites);
            rankingSection.classList.toggle('is-hidden', !(isHome || isRanking) || isSearching);
            resultsContainer.classList.toggle('is-hidden', isFavorites || isRanking);

            renderRankingSection();
        }

        // „Å≤„Çâ„Åå„Å™„Çí„Ç´„Çø„Ç´„Éä„Å´Â§âÊèõ
        function hiraganaToKatakana(str) {
            return str.replace(/[\u3041-\u3096]/g, function(match) {
                const chr = match.charCodeAt(0) + 0x60;
                return String.fromCharCode(chr);
            });
        }

        function normalizeKana(str) {
            return normalizeText(hiraganaToKatakana(str || ''));
        }

        function normalizeText(str) {
            return (str || '').toLowerCase().trim();
        }

        function getAirportFullName(code) {
            return airportFullNames[code] || '';
        }

        function findExactAirport(searchTerm) {
            const term = normalizeText(searchTerm);
            if (!term) return null;
            const katakana = normalizeKana(searchTerm);

            // code match
            const byCode = uniqueCities.find(c => normalizeText(c.code) === term);
            if (byCode) return byCode.en;

            // exact en / ja match
            const byEn = uniqueCities.find(c => normalizeText(c.en) === term);
            if (byEn) return byEn.en;

            const byJa = uniqueCities.find(c => {
                const ja = normalizeKana(c.ja);
                return ja === term || ja === katakana;
            });
            if (byJa) return byJa.en;

            return null;
        }

        function getAirportsByCityOrCountry(searchTerm) {
            const term = normalizeText(searchTerm);
            if (!term) return [];
            const katakana = normalizeKana(searchTerm);

            const matches = uniqueCities.filter(city => {
                const ja = normalizeKana(city.ja);
                const en = normalizeText(city.en);
                const country = normalizeText(city.country);
                return (
                    ja.includes(term) || ja.includes(katakana) ||
                    en.includes(term) ||
                    country.includes(term)
                );
            });

            // unique by en
            const seen = new Set();
            return matches.filter(c => {
                if (seen.has(c.en)) return false;
                seen.add(c.en);
                return true;
            }).sort((a, b) => a.ja.localeCompare(b.ja, 'ja'));
        }

        // Ê§úÁ¥¢Ê©üËÉΩ„Å®„Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„Éà
        const searchInput = document.getElementById('searchInput');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        const listView = document.getElementById('listView');
        const detailView = document.getElementById('detailView');
        const detailTitle = document.getElementById('detailTitle');
const detailSub = document.getElementById('detailSub');
const detailCount = document.getElementById('detailCount');
const detailGrid = document.getElementById('detailGrid');
const backButton = document.getElementById('backButton');
const detailCopyBtn = document.getElementById('detailCopyBtn');
const detailFavBtn = document.getElementById('detailFavBtn');
const detailSort = document.getElementById('detailSort');
const detailMapBtn = document.getElementById('detailMapBtn');
const detailNameCopyBtn = document.getElementById('detailNameCopyBtn');
        const homeButton = document.getElementById('homeButton');
const favoritesSection = document.getElementById('favoritesSection');
const favoritesGrid = document.getElementById('favoritesGrid');
const rankingSection = document.getElementById('rankingSection');
const rankingGrid = document.getElementById('rankingGrid');
const resultsContainer = document.getElementById('resultsContainer');
const favoritesTabBtn = document.getElementById('favoritesTabBtn');
const rankingToggleBtn = document.getElementById('rankingToggleBtn');
const toast = document.getElementById('toast');

        // ÂàùÊúüË°®Á§∫
        if (!dataLoaded) {
            const grid = document.getElementById('flightsGrid');
            if (grid) {
                grid.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">!</div>
                        <h3>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</h3>
                        <p>data.js „ÅåË™≠„ÅøËæº„ÇÅ„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô</p>
                    </div>
                `;
            }
        }
        renderFavoritesSection();
        renderRankingSection();
        updateTabView();
        filterAndDisplay('');

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            clearTimeout(toast._timer);
            toast._timer = setTimeout(() => {
                toast.classList.remove('show');
            }, 1600);
        }

        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                showToast(`${text} „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`);
            } catch (err) {
                showToast('„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
        }

        function renderDetailView(airportEn) {
            const info = cityInfoByEn.get(airportEn);
            if (!info) return;

            const connections = Array.from(connectionsMap.get(airportEn) || []);
            const enriched = connections.map(name => {
                const city = cityInfoByEn.get(name) || { en: name, ja: name, code: '???', country: '' };
                const count = connectionsMap.get(city.en) ? connectionsMap.get(city.en).size : 0;
                return {
                    en: city.en,
                    code: city.code,
                    ja: city.ja,
                    country: city.country,
                    count
                };
            });

            const fullName = getAirportFullName(info.code);
            detailTitle.textContent = `${info.ja}Ôºà${info.code}Ôºâ`;
            detailSub.innerHTML = `${info.en} / <span class="detail-country-link" data-country="${info.country}">${info.country}</span>${fullName ? `<span class=\"detail-airport-name\">${fullName}</span>` : ''}`;
            detailCount.textContent = `Êé•Á∂öÊï∞: ${enriched.length}`;
            detailCopyBtn.dataset.copyCode = info.code;
            detailFavBtn.classList.toggle('active', isFavorite(info.en));
            detailFavBtn.dataset.favAirport = info.en;
            detailNameCopyBtn.dataset.copyName = fullName || info.ja;
            const mapUrl = airportGoogleMap[info.en];
            if (mapUrl) {
                detailMapBtn.href = mapUrl.trim();
                detailMapBtn.classList.remove('is-hidden');
            } else {
                detailMapBtn.href = '#';
                detailMapBtn.classList.add('is-hidden');
            }
            currentDetailAirport = airportEn;
            renderDetailGrid(enriched);

            listView.classList.add('is-hidden');
            detailView.classList.remove('is-hidden');
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        function renderDetailGrid(enriched) {
            if (detailSortMode === 'count') {
                enriched.sort((a, b) => b.count - a.count || a.ja.localeCompare(b.ja, 'ja'));
                detailGrid.innerHTML = enriched.map(city => `
                    <div class="airport-chip" data-airport="${city.en}">
                        <div class="airport-chip-code">${city.code}</div>
                        <div class="airport-chip-name">${city.ja}</div>
                        <div class="airport-chip-country">${city.country}</div>
                        <div class="detail-chip-meta">Êé•Á∂öÊï∞: ${city.count}</div>
                    </div>
                `).join('');
                return;
            } else if (detailSortMode === 'country') {
                const grouped = new Map();
                enriched.forEach(city => {
                    const key = city.country || '„Åù„ÅÆ‰ªñ';
                    if (!grouped.has(key)) grouped.set(key, []);
                    grouped.get(key).push(city);
                });
                const palette = [
                    '#D32F2F', '#1976D2', '#388E3C', '#F57C00',
                    '#7B1FA2', '#00796B', '#C2185B', '#5D4037',
                    '#455A64', '#303F9F', '#0288D1', '#689F38'
                ];

                const ordered = Array.from(grouped.entries()).sort((a, b) => a[0].localeCompare(b[0], 'ja'))
                    .flatMap(([country, cities], index) => {
                        cities.sort((a, b) => a.ja.localeCompare(b.ja, 'ja'));
                        const color = palette[index % palette.length];
                        return cities.map(city => ({
                            ...city,
                            color
                        }));
                    });
                detailGrid.innerHTML = ordered.map(city => `
                    <div class="airport-chip" data-airport="${city.en}" style="border-left: 4px solid ${city.color};">
                        <div class="airport-chip-code">${city.code}</div>
                        <div class="airport-chip-name">${city.ja}</div>
                        <div class="airport-chip-country">${city.country}</div>
                        <div class="detail-chip-meta">Êé•Á∂öÊï∞: ${city.count}</div>
                    </div>
                `).join('');
                return;
            }
        }

        function openDetailView(airportEn) {
            history.pushState({ view: 'detail', airport: airportEn }, '', location.pathname + location.search);
            renderDetailView(airportEn);
        }

        function closeDetailView() {
            detailView.classList.add('is-hidden');
            listView.classList.remove('is-hidden');
        }

        function openListView() {
            closeDetailView();
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        backButton.addEventListener('click', () => {
            if (history.state && history.state.view === 'detail') {
                history.back();
            } else {
                openListView();
            }
        });
detailCopyBtn.addEventListener('click', () => {
    const code = detailCopyBtn.dataset.copyCode;
    if (code) {
        copyToClipboard(code);
    }
});

detailFavBtn.addEventListener('click', () => {
    const airport = detailFavBtn.dataset.favAirport;
    if (airport) {
        toggleFavorite(airport);
        detailFavBtn.classList.toggle('active', isFavorite(airport));
    }
});

detailNameCopyBtn.addEventListener('click', () => {
    const name = detailNameCopyBtn.dataset.copyName;
    if (name) {
        copyToClipboard(name);
    }
});

detailSub.addEventListener('click', (e) => {
    const target = e.target.closest('[data-country]');
    if (!target) return;
    const country = target.dataset.country;
    if (!country) return;
    searchInput.value = country;
    currentFilter = 'all';
    filterButtons.forEach(b => b.classList.remove('active'));
    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
    if (allButton) {
        allButton.classList.add('active');
    }
    const airportList = getAirportsByCityOrCountry(country);
    searchMode = 'airports';
    displayAirports(airportList);
    updateTabView();
    openListView();
});

detailSort.addEventListener('change', (e) => {
    detailSortMode = e.target.value;
    if (!currentDetailAirport) return;
            const connections = Array.from(connectionsMap.get(currentDetailAirport) || []);
            const enriched = connections.map(name => {
                const city = cityInfoByEn.get(name) || { en: name, ja: name, code: '???', country: '' };
                const count = connectionsMap.get(city.en) ? connectionsMap.get(city.en).size : 0;
                return {
                    en: city.en,
                    code: city.code,
                    ja: city.ja,
                    country: city.country,
                    count
                };
            });
            renderDetailGrid(enriched);
        });

homeButton.addEventListener('click', () => {
    history.pushState({ view: 'list' }, '', location.pathname + location.search);
    currentFilter = 'all';
    filterButtons.forEach(b => b.classList.remove('active'));
    const allButton = document.querySelector('.filter-btn[data-filter="all"]');
    if (allButton) {
        allButton.classList.add('active');
    }
    searchInput.value = '';
    autocompleteDropdown.classList.remove('show');
    searchMode = 'routes';
    filterAndDisplay('');
    updateTabView();
    openListView();
});

        history.replaceState({ view: 'list' }, '', location.pathname + location.search);
        window.addEventListener('popstate', (e) => {
            const state = e.state || { view: 'list' };
            if (state.view === 'detail' && state.airport) {
                renderDetailView(state.airport);
            } else {
                openListView();
            }
        });

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            
            if (searchTerm.length === 0) {
                autocompleteDropdown.classList.remove('show');
                searchMode = 'routes';
                filterAndDisplay('');
                updateTabView();
                return;
            }

            showAutocomplete(searchTerm);

            const exactAirport = findExactAirport(searchTerm);
            if (exactAirport) {
                searchMode = 'routes';
                autocompleteDropdown.classList.remove('show');
                openDetailView(exactAirport);
                updateTabView();
                return;
            }

            const airportList = getAirportsByCityOrCountry(searchTerm);
            if (airportList.length > 0) {
                searchMode = 'airports';
                displayAirports(airportList);
                updateTabView();
                return;
            }

            searchMode = 'routes';
            filterAndDisplay(searchTerm.toLowerCase());
            updateTabView();
        });

        // „Ç™„Éº„Éà„Ç≥„É≥„Éó„É™„Éº„ÉàÂÄôË£ú„ÇíË°®Á§∫
        function showAutocomplete(searchTerm) {
            const lowerSearchTerm = normalizeText(searchTerm);
            const katakanaLower = normalizeKana(searchTerm);

            const cityMatches = uniqueCities.filter(city => {
                const jaValue = normalizeKana(city.ja);
                const enValue = normalizeText(city.en);
                const codeValue = normalizeText(city.code);
                return (
                    jaValue.startsWith(lowerSearchTerm) ||
                    jaValue.startsWith(katakanaLower) ||
                    enValue.startsWith(lowerSearchTerm) ||
                    codeValue.startsWith(lowerSearchTerm)
                );
            }).slice(0, 6);

            const countrySet = new Map();
            uniqueCities.forEach(city => {
                if (!city.country) return;
                if (!countrySet.has(city.country)) {
                    countrySet.set(city.country, city.country);
                }
            });

            const countryMatches = Array.from(countrySet.keys()).filter(country => {
                const jaValue = normalizeKana(country);
                return jaValue.startsWith(lowerSearchTerm) || jaValue.startsWith(katakanaLower);
            }).slice(0, 4);

            if (cityMatches.length === 0 && countryMatches.length === 0) {
                autocompleteDropdown.classList.remove('show');
                return;
            }

            const cityItems = cityMatches.map(city => `
                <div class="autocomplete-item" data-city="${city.en}">
                    <div class="autocomplete-item-main">${city.ja} <span class="autocomplete-item-code">[${city.code}]</span></div>
                    <div class="autocomplete-item-sub">${city.en} - ${city.country}</div>
                </div>
            `).join('');

            const countryItems = countryMatches.map(country => `
                <div class="autocomplete-item" data-country="${country}">
                    <div class="autocomplete-item-main">${country}</div>
                    <div class="autocomplete-item-sub">ÂõΩÂêç</div>
                </div>
            `).join('');

            autocompleteDropdown.innerHTML = `${countryItems}${cityItems}`;
            autocompleteDropdown.classList.add('show');

            document.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const cityEn = item.dataset.city;
                    const country = item.dataset.country;
                    if (cityEn) {
                        const selectedCity = uniqueCities.find(c => c.en === cityEn);
                        searchInput.value = selectedCity.ja;
                        autocompleteDropdown.classList.remove('show');
                        searchMode = 'routes';
                        openDetailView(selectedCity.en);
                        return;
                    }
                    if (country) {
                        searchInput.value = country;
                        autocompleteDropdown.classList.remove('show');
                        const airportList = getAirportsByCityOrCountry(country);
                        searchMode = 'airports';
                        displayAirports(airportList);
                    }
                });
            });
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-wrapper')) {
                autocompleteDropdown.classList.remove('show');
            }
        });

        // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateTabView();
                if (currentFilter === 'favorites' || currentFilter === 'ranking') {
                    return;
                }
                filterAndDisplay(searchInput.value.toLowerCase().trim());
            });
        });

        // „ÇΩ„Éº„ÉàÊ©üËÉΩ
        const sortSelect = document.getElementById('sortSelect');
        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortFlights();
            displayFlights(filteredFlights);
        });

        function filterAndDisplay(searchTerm) {
            const katakanaSearchTerm = hiraganaToKatakana(searchTerm);

            if (currentFilter === 'favorites' || currentFilter === 'ranking') {
                return;
            }

            if (searchMode === 'airports') {
                return;
            }

            filteredFlights = flightsData.filter(flight => {
                const regionMatch = currentFilter === 'all' || flight.region === currentFilter;

                const searchMatch = !searchTerm || 
                    flight.fromCity.toLowerCase().includes(searchTerm) ||
                    flight.fromCity.toLowerCase().includes(katakanaSearchTerm) ||
                    flight.toCity.toLowerCase().includes(searchTerm) ||
                    flight.toCity.toLowerCase().includes(katakanaSearchTerm) ||
                    flight.fromCountry.toLowerCase().includes(searchTerm) ||
                    flight.toCountry.toLowerCase().includes(searchTerm) ||
                    flight.from.toLowerCase().includes(searchTerm) ||
                    flight.to.toLowerCase().includes(searchTerm) ||
                    flight.fromCode.toLowerCase().includes(searchTerm) ||
                    flight.toCode.toLowerCase().includes(searchTerm);

                return regionMatch && searchMatch;
            });

            sortFlights();
            displayFlights(filteredFlights);
        }

        function sortFlights() {
            if (currentSort === 'ja-asc') {
                // Êó•Êú¨Ë™û„ÅÇ„ÅÑ„ÅÜ„Åà„ÅäÈ†ÜÔºàÊòáÈ†ÜÔºâ
                filteredFlights.sort((a, b) => a.fromCity.localeCompare(b.fromCity, 'ja'));
            } else if (currentSort === 'ja-desc') {
                // Êó•Êú¨Ë™ûÈÄÜÈ†ÜÔºàÈôçÈ†ÜÔºâ
                filteredFlights.sort((a, b) => b.fromCity.localeCompare(a.fromCity, 'ja'));
            }
        }

        function displayFlights(flights) {
            const grid = document.getElementById('flightsGrid');
            const resultCount = document.getElementById('resultCount');
            const groupCount = document.getElementById('groupCount');

            resultCount.textContent = flights.length;

            if (flights.length === 0) {
                groupCount.textContent = 0;
                grid.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">‚úàÔ∏è</div>
                        <h3>Ê§úÁ¥¢ÁµêÊûú„Å™„Åó</h3>
                        <p>Âà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Åß<br>Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                `;
                return;
            }

            const groupMap = new Map();
            flights.forEach(flight => {
                if (!groupMap.has(flight.from)) {
                    groupMap.set(flight.from, {
                        from: flight.from,
                        fromCode: flight.fromCode,
                        fromCity: flight.fromCity,
                        fromCountry: flight.fromCountry,
                        destinations: new Map()
                    });
                }
                const group = groupMap.get(flight.from);
                if (!group.destinations.has(flight.to)) {
                    group.destinations.set(flight.to, {
                        to: flight.to,
                        toCode: flight.toCode,
                        toCity: flight.toCity,
                        toCountry: flight.toCountry
                    });
                }
            });

            let groups = Array.from(groupMap.values());
            if (currentSort === 'ja-asc') {
                groups.sort((a, b) => a.fromCity.localeCompare(b.fromCity, 'ja'));
            } else if (currentSort === 'ja-desc') {
                groups.sort((a, b) => b.fromCity.localeCompare(a.fromCity, 'ja'));
            }

            groupCount.textContent = groups.length;

            grid.innerHTML = groups.map((group, index) => {
                const destinations = Array.from(group.destinations.values())
                    .sort((a, b) => a.toCity.localeCompare(b.toCity, 'ja'));

                return `
                    <div class="flight-group" data-airport="${group.from}" style="animation-delay: ${Math.min(index * 0.015, 0.5)}s">
                        <div class="flight-group-header">
                            <div class="airport-title">
                                <div class="airport-code">${group.fromCode}</div>
                                <div>
                                    <div class="airport-name">${group.fromCity}</div>
                                    <div class="airport-country">${group.fromCountry}</div>
                                </div>
                            </div>
                            <div class="airport-actions">
                                <button class="star-btn ${isFavorite(group.from) ? 'active' : ''}" type="button" data-fav-airport="${group.from}">‚òÖ</button>
                            </div>
                        </div>
                        <div class="flight-group-body">
                            <div class="destinations">
                                ${destinations.map(dest => `
                                    <div class="airport-chip" data-airport="${dest.to}">
                                        <div class="airport-chip-code">${dest.toCode}</div>
                                        <div class="airport-chip-name">${dest.toCity}</div>
                                        <div class="airport-chip-country">${dest.toCountry}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayAirports(airports) {
            const grid = document.getElementById('flightsGrid');
            const resultCount = document.getElementById('resultCount');
            const groupCount = document.getElementById('groupCount');

            resultCount.textContent = airports.length;
            groupCount.textContent = airports.length;

            if (airports.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">‚úàÔ∏è</div>
                        <h3>Ê§úÁ¥¢ÁµêÊûú„Å™„Åó</h3>
                        <p>Âà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Åß<br>Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                `;
                return;
            }

            const sortedAirports = airports.map(city => {
                const connections = connectionsMap.get(city.en);
                const count = connections ? connections.size : 0;
                return { ...city, count };
            }).sort((a, b) => b.count - a.count || a.ja.localeCompare(b.ja, 'ja'));

            grid.innerHTML = sortedAirports.map((city, index) => {
                return `
                    <div class="flight-group" data-airport="${city.en}" style="animation-delay: ${Math.min(index * 0.015, 0.5)}s">
                        <div class="flight-group-header">
                            <div class="airport-title">
                                <div class="airport-code">${city.code}</div>
                                <div>
                                    <div class="airport-name">${city.ja}</div>
                                    <div class="airport-country">${city.country}</div>
                                    <div class="airport-meta">Êé•Á∂öÊï∞: ${city.count}</div>
                                </div>
                            </div>
                            <div class="airport-actions">
                                <button class="star-btn ${isFavorite(city.en) ? 'active' : ''}" type="button" data-fav-airport="${city.en}">‚òÖ</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        const flightsGrid = document.getElementById('flightsGrid');
        flightsGrid.addEventListener('click', (e) => {
            const favTarget = e.target.closest('[data-fav-airport]');
            if (favTarget) {
                e.stopPropagation();
                toggleFavorite(favTarget.dataset.favAirport);
                return;
            }
            const airportTarget = e.target.closest('[data-airport]');
            if (airportTarget) {
                openDetailView(airportTarget.dataset.airport);
            }
        });

        detailGrid.addEventListener('click', (e) => {
            const airportTarget = e.target.closest('[data-airport]');
            if (airportTarget) {
                openDetailView(airportTarget.dataset.airport);
            }
        });

        favoritesGrid.addEventListener('click', (e) => {
            const airportTarget = e.target.closest('[data-airport]');
            if (airportTarget) {
                openDetailView(airportTarget.dataset.airport);
            }
        });

rankingGrid.addEventListener('click', (e) => {
    const airportTarget = e.target.closest('[data-airport]');
    if (airportTarget) {
        openDetailView(airportTarget.dataset.airport);
    }
});

rankingToggleBtn.addEventListener('click', () => {
    rankingExpanded = !rankingExpanded;
    renderRankingSection();
});
    </script>
</body>
</html>
